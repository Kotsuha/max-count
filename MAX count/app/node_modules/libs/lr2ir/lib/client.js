"use strict";

const rp = require("request-promise");

const cookieJar = rp.jar();

const getCookie = function() {
	const { HOST, PATH } = URL;
	const host = HOST,
		  path = "/" + PATH[0] + "/" + PATH[1];
	let value = 
		cookieJar._jar.store.idx[host] 
	 && cookieJar._jar.store.idx[host][path];
	let cookie = value || null;
	return cookie;
};

const isExpired = function() {
	let result;
	const cookie = getCookie();

	if (cookie === null) {
		result = true;
	}
	else {
		const expires = cookie.login.expires; // 只要這個格式是 Date.parse() 吃的，應該就沒事
		let timeNow = Date.now(),
			timeExp = Date.parse(expires);
		result = (timeNow >= timeExp);
	}
	if (result) console.log("isExpired() 結果:", result); // TODO
	return result;
};

let request = function(options) {
	return rp(options);
};

// https://stackoverflow.com/questions/31270461/what-is-the-difference-between-cookie-and-cookiejar
const client = {
	cookieJar: cookieJar,
	getCookie: getCookie,
	isExpired: isExpired,
	request: request
};

module.exports = client;
